---
- hosts: testnodes
  become: yes
  remote_user: devopsadmin
  roles:
        - tomcatrole
---
tasks:
  - name: Make sure we are able to connect server
    ping: null	
  - name: update packages
    yum: name=update state=latest update_cache=true exclude=kernel*,foo	
  - name: Install java 17 jdk
    yum: name=java-17-amazon-corretto-devel state=present	
  - name: validate if java is available
    command: java --version
  - name: create group "tomcat"
    group: name=tomcat state=present
  - name: create user "tomcat"
    user: name=tomcat group=tomcat createhome=yes state=present
  - name: make directory
    file: path=/opt/tomcat state=directory mode=0755 owner=tomcat group=tomcat
  - name: download tomcat
    vars: download_url=https://downloads.apache.org/tomcat/tomcat-8/v8.5.95/bin/apache-tomcat-8.5.95.tar.gz 
  - name: unarchive tomcat using get_url
    become: yes
    unarchive: src="{{donwload_url}}" dest=/opt/tomcat mode=0755 remote_src=yes group=tomcat owner=tomcat

	 
  - name: Creating a service file
    become: yes
    copy: dest=/etc/systemd/system/tomcat.service
       content: |
         [Unit]
	     Description=Apache Tomcat service
             Requires=network.target
	     After=network.target
	     
	     [Service]
	     Type=forking
	     Environment=JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-amd64/jre
	     Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid
	     Environment=CATALINA_HOME=/opt/tomcat
	     Environment=CATALINA_BASE=/opt/tomcat
	     Environment='CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC'
	     Environment='JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom'
	     
	     ExecStart=/opt/tomcat/bin/startup.sh
	     ExecStop=/opt/tomcat/bin/shutdown.sh
	     User=tomcat
	     Group=tomcat
	     UMask=0007
	     RestartSec=10
	     Restart=always
	     
	     [Install]
	     WantedBy=multi-user.target
  - name: Copy Tomcat service from local to remote
      copy:
        src: /etc/tomcat.service
        dest: /etc/systemd/system/
        mode: 0755
	 
  - name: Enable the tomcat service and start 
    become: yes
	systemd: name=tomcat enabled=yes state=started daemon_reload=true
